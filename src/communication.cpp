#include "communication.h"

void setBrightness(uint8_t level) {
    if (level > 0xFD) level = 0xFD;
    
    if (level == 0x00) {
        unsigned char off[1] = {0xFE};
        CAN.sendMsgBuf(0x202, 0, 1, off);
        current.iDriveLightOn = false;
    } else {
        unsigned char data[1] = {level};
        CAN.sendMsgBuf(0x202, 0, 1, data);
        current.brightnessLevel = level;
        current.iDriveLightOn = true;
    }
    delay(30);
}

void adjustBrightness(int8_t delta) {
    uint8_t newLevel;
    
    if (delta > 0) {
        newLevel = min(0xFD, current.brightnessLevel + 0x20);
        if (current.brightnessLevel == 0x00) newLevel = 0x20;
    } else {
        newLevel = (current.brightnessLevel <= 0x20) ? 0x00 : current.brightnessLevel - 0x20;
    }
    
    setBrightness(newLevel);
    
    Serial.print("Brightness: 0x");
    Serial.print(newLevel, HEX);
    Serial.print(" (");
    Serial.print(newLevel ? (newLevel * 100) / 0xFD : 0);
    Serial.println("%)");
}

void sendKeepAlive() {
    unsigned char keepalive[8] = {0x40, 0x10, 0x00, 0x02, 0x03, 0x92, 0x01, 0x00};
    CAN.sendMsgBuf(IDRIVE_KEEPALIVE_ID, 0, 8, keepalive);
    current.lastKeepAliveTime = millis();
}

void sendStatusBurst() {
    // Cycle through the 14-entry 0x3C status burst table, aint workin
    static const unsigned char WAKE_BURST[14][8] = {
        {0xD0, 0xAE, 0x02, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0x6B, 0xA2, 0x02, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0x03, 0xA8, 0x02, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0x37, 0xAD, 0x02, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0x5F, 0xA7, 0x02, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0xB9, 0xAA, 0x02, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0xE5, 0xA5, 0x02, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0x5E, 0xA9, 0x02, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0x71, 0xAD, 0x03, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0xA3, 0xA5, 0x03, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0x44, 0xA6, 0x03, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0x97, 0xA0, 0x03, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0x19, 0xA7, 0x03, 0x92, 0x01, 0x00, 0x2A, 0xFF},
        {0x2C, 0xAC, 0x03, 0x92, 0x01, 0x00, 0x2A, 0xFF}
    };

    CAN.sendMsgBuf(IDRIVE_STATUS_BURST_ID, 0, 8, (unsigned char*)WAKE_BURST[current.statusBurstIndex]);
    current.statusBurstIndex = (current.statusBurstIndex + 1) % 14;
    current.lastStatusBurstTime = millis();
}